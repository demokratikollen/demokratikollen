{% extends "proposals/base.html" %}

{% block styles -%}{{ super() }}
    <style>
.canvas {
}
.origin-parties {
  shape-rendering: crispEdges;
}

rect.node {
    fill: #333333;
    stroke: #111111;
}
rect.node-group {
    fill: #888888;
    stroke: #111111;
}


    </style>

{%- endblock %}


{% block content %}
<div class="row">
    <div class="col-lg-1"></div>
    <div class="col-lg-10">
    <svg id="proposals-main" class='canvas' viewBox='0 0 940 440' preserveAspectRatio="xMinYMin meet"/>        
    </div>
</div> 
{% endblock %}

{% block scripts %}{{ super() }}
    <script type="text/javascript">

testdata = {
  nodes: [
    {
      layer: 0,
      x: 0,
      items: [
        {
          title: 'Partiernas motioner',
          items: [
            {
              title: 'V'
            },
            {
              title: 'S'
            }
          ]
        },
        {
          title: 'Samsignerade motioner',
          items: [
            {
              title: 'V och S'
            },
            {
              title: 'M och FP'
            }
          ]
        },
        {
          title: 'Regeringens propositioner',
          items: [
            {
              title: 'UD'
            },
            {
              title: "FD"
            }
          ]
        }
      ]
    },
    {
      layer: 1,
      x: 0.5,
      items: [
        {
          title: 'Utskotten',
          items: [
            {
              title: 'UU'
            },
            {
              title: 'FiU'
            },
            {
              title: 'FÃ¶U'
            }
          ]
        }
      ]
    },
    {
      layer: 2,
      x: 1.0,
      items: [
        {
          title: 'Besluten',
          items: [
            {
              title: 'Bifall'
            },
            {
              title: 'Avslag'
            }
          ]
        }
      ]
    }
  ], //nodes

  flows: [
    {
      path: [[0,0,0],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,0],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,0,0],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,0],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,0,0],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,0],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },//V

    {
      path: [[0,0,1],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,1],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,0,1],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,1],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,0,1],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,0,1],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },

    {
      path: [[0,1,0],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,0],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,1,0],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,0],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,1,0],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,0],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },//V

    {
      path: [[0,1,1],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,1],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,1,1],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,1],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,1,1],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,1,1],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },

    {
      path: [[0,2,0],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,0],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,2,0],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,0],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,2,0],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,0],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },//V

    {
      path: [[0,2,1],[1,0,0],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,1],[1,0,0],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }, 
    {
      path: [[0,2,1],[1,0,1],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,1],[1,0,1],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },  
    {
      path: [[0,2,1],[1,0,2],[2,0,0]],
      magnitude: Math.floor(Math.random() * 50) + 2
    },
    {
      path: [[0,2,1],[1,0,2],[2,0,1]],
      magnitude: Math.floor(Math.random() * 50) + 2
    }             
  ] // flows
};
function prop(p) {

  return function(d) {
    return d[p];
  };

}
proposals_main = function() {

  var width, height;

  var node_yspacing = 5,
      node_group_yspacing = 25;

  var node_group_ypadding = 12;

  var node_group_width = 100;
  var node_width = 40;

  function sankey(selection){
    selection.each(function(data){

      var yscale;

      compute_positions = function() {
        node_layers = data.nodes;

        node_layers.forEach(function(layer){
          y = 0.5*(height-layer.total_height);
          layer.items.forEach(function(group){

            group.x = (width-node_group_width)*layer.x;
            group.y = y;
            y += node_group_ypadding;

            group.items.forEach(function(node){
              node.x = group.x + 0.5*(node_group_width-node_width);
              node.y = y;
              y += node.size * yscale;
              node.height = y - node.y;
              y += node_yspacing;
            });

            y -= node_yspacing;
            y += node_group_ypadding;
            group.height = y - group.y;
            
            y += node_group_yspacing;

          });
          y -= node_group_yspacing;
        });
      };

      compute_sizes = function() {

        nodes = data.nodes;
        flows = data.flows;

        // compute and store sizes of all layers, groups and nodes by counting flows through them
        flows.forEach(function(flow){
          flow.path.forEach(function(p) {
            layer = nodes[p[0]];
            node_group = layer.items[p[1]];
            node = node_group.items[p[2]];
            layer.size = layer.size + flow.magnitude || flow.magnitude;
            node_group.size = node_group.size + flow.magnitude || flow.magnitude;
            node.size = node.size + flow.magnitude || flow.magnitude;
          });
        });

        
        nodes.forEach(function(layer){
          layer.num_node_spacings = d3.sum(layer.items, function(g){return g.items.length-1;});
          layer.num_group_spacings = layer.items.length-1;
        });

        // yscale calibrated to fill height after equation:
        // height == size*yscale + group_spacing + group_padding + node_spacing
        // (take worst case: smallest value)
        yscale = d3.min(nodes, function(d){
          return (height 
                  - d.num_group_spacings*node_group_yspacing
                  - d.items.length*node_group_ypadding*2
                  - d.num_node_spacings*node_yspacing)/d.size;
        });

        nodes.forEach(function(layer){
          layer.total_height = layer.size * yscale
                              + layer.num_group_spacings*node_group_yspacing
                              + layer.items.length*node_group_ypadding*2
                              + layer.num_node_spacings*node_yspacing;
        });


      };

      compute_sizes();
      compute_positions();

      var parent = d3.select(this);

      var node_layers = parent.selectAll(".node-layers")
                            .data(prop("nodes"));
      node_layers.enter()
                  .append("g").classed("node-layer",true);

      var node_groups = node_layers.selectAll(".node-group")
                                    .data(prop("items"));
      node_groups.enter()
                  .append("g").classed("node-group", true);

      node_groups.append("rect")
            .classed("node-group", true)
            .attr("x", prop("x"))
            .attr("y", prop("y"))
            .attr("width", node_group_width)
            .attr("height", prop("height"));

      var nodes = node_groups.selectAll(".node")
                          .data(prop("items"));
      nodes.enter()
            .append("g").classed("node", true)
      nodes.append("rect")
            .classed("node", true)
            .attr("x", prop("x"))
            .attr("y", prop("y"))
            .attr("width", node_width)
            .attr("height",prop("height"));
    });

  };
  
  sankey.width = function(_) {
    if (!arguments.length) return width;
    else width = +_;
    return sankey;
  }
  sankey.height = function(_) {
    if (!arguments.length) return height;
    else height = +_;
    return sankey;
  }    

  return sankey;
};

$(d3.select("#proposals-main").datum(testdata).call(
  proposals_main()
    .width(940)
    .height(440)
  )); 

    </script>
{%- endblock %}