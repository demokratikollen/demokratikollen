{% extends "parties/base.html" %}
{% block content %}

<div class="row">
    <div class="col-md-4">
        <div id="cosigning"></div>        
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div id="party-bias"></div>        
    </div>
</div>
    
{% endblock %}
{% block styles %}
<style>

.axis path, .axis line {
  fill: none;
  stroke: #555;
  shape-rendering: crispEdges;
}
.axis text {
  font-size: 11px;
}

.line-path {
  fill: none;
  stroke: #111;
}

path.line {
  fill:none;
  stroke-width: 2px;
}
circle.marker {
  fill:#ffffff;
  pointer-events: 'none';
  stroke-width: '2px';
}

</style> 
{% endblock %}

{% block scripts %}
{{ super() }}

<script type="text/javascript">

function prop(p) {
  return function(d) {
    return d[p];
  };
}

cosigningData = {{ cosigning_data | tojson | safe }};

ordinalLineGraph = function() {

  margin = { top: 25, right: 25, bottom: 50, left: 50 };

  function graph(selection) {
    selection.each(function(data) {

      var boundingRect = this.getBoundingClientRect();
      var width = boundingRect.width - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;

      var parent = d3.select(this);
      var select = parent.append("select").attr("class", "graph-filter");
      var options = select.selectAll("option").data(data.committees);
      options.enter().append("option")       
        .text(prop("name"))

      var top = parent.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var tScale = d3.scale.ordinal()
          .domain(d3.range(data.t.length))
          .rangePoints([0,width]);

      var tAxis = d3.svg.axis()
          .scale(tScale)
          .tickFormat(function(d) { return data.t[d]; })
          .orient("bottom");

      var tAxisElement = top.append("g")
                            .attr("transform", "translate(0," + height + ")")
                          .attr("class", "axis x-axis");
      var yAxisElement = top.append("g")
                          .attr("class", "axis y-axis");

      select.on("change", function() {
        var i = d3.select(this).property("selectedIndex");
        var series = data.committees[i].series;

        var maxValue = d3.max(series, function(s){return d3.max(s.values);});
        var minValue = d3.min(series, function(s){return d3.min(s.values);});
        var yScale = d3.scale.linear()
            .domain([minValue, maxValue])
            .range([height,0]);
        var lineGenerator = d3.svg.line()
          .x(function(d,i) { return tScale(i); })
          .y(function(d,i) { return yScale(d); })
          .defined(function(d) { return d != 0; });

        
        var lineGroups = top.selectAll(".line-group").data(series);
        var enteringLineGroups = lineGroups.enter()
          .append("g").attr("class", "line-group");
        var enteringPaths = enteringLineGroups.append("path");
        enteringPaths
          .attr("class","line-path")
          .attr("d", function(d,i){return lineGenerator(d.values);})        


        lineGroups.exit().remove();

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left");
        tAxisElement.call(tAxis)
                      .selectAll("text")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform","rotate(-60)");
        yAxisElement.call(yAxis);
      });
      select.on("change").apply(select[0][0], null); // initial display

    }); // selection.each
  } // function graph


  return graph;
}


$(d3.select("#cosigning").datum(cosigningData).call(
  ordinalLineGraph()
  ));   


party_bias = {
    setup: function(){

        yticklabels = {{ party_bias_yticklabels | tojson | safe }};
        parties = {{ party_bias_parties | tojson | safe}};

        partyColors = {"S": "#ED1B34", "M": "#52BDEC", "SD": "#FBC700", 
                      "MP": "#53A045", "C": "#016A3A", "V": "#D9291C",
                      "FP": "#004B92", "KD": "#073192"};

        var margin = {top: 20, right: 20, bottom: 30, left: 60},
            width = 300 - margin.left - margin.right,
            height =400 - margin.top - margin.bottom;

        var svg = d3.select("#party-bias").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x = d3.scale.linear()
            .domain([-1.1,1.1])
            .range([0, width]);

        var y = d3.scale.ordinal()
            .domain(d3.range(yticklabels.length))
            .rangePoints([height, 0]);

        var yAxis = d3.svg.axis()
            .scale(y)
            .tickFormat(function(d, i) { return yticklabels[d]; })
            .orient("left");

        var line = d3.svg.line()
            .x(function(d,i) { return x(d[1]); })
            .y(function(d,i) { return y(d[0]); })
            .defined(function(d,i) { return !isNaN(d[1]); });

        var paths = svg.selectAll( "path" )
          .data(parties);

        paths.enter().append("path");

        paths
          .classed({"line":true})
          .style("stroke", function(d){return partyColors[d.abbr];})
          .attr("d", function(d){return line(d.data);});


        var marker_groups = svg.selectAll(".marker-group")
          .data(parties);

        marker_groups.enter().append("g");

        marker_groups
          .classed({"marker-group":true});

        var markers = marker_groups.selectAll("circle")
          .data(function(d){return d.data.filter(function(x){return !isNaN(x[1]);})});

        markers.enter().append("circle");

        markers
          .classed({"marker":true})
          .attr("cx", line.x())
          .attr("cy", line.y())
          .attr('r', 4)
          .style('stroke', function(d){return partyColors[this.parentNode.__data__.abbr];});

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);
        
        return this;
    } // setup
}

$(party_bias.setup());
</script>  

{% endblock %}