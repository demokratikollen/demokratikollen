{% set title = party.name + " - Demokratikollen" %}
{% extends "parties/base.html" %}

{% block styles %}
{{ super() }}
<style>
rect {
  fill: #ddd;
}

.axis path,
.axis line {
  fill: none;
  stroke: #ddd;
  shape-rendering: crispEdges;
}

.axis text {
  font-size: 10px;
  fill: #eee;
}
/*
.x.axis path {
  display: none;
}
*/
.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}


.axis path, .axis line {
  fill: none;
  stroke: #888;
  shape-rendering: crispEdges;
}
.axis text {
    font-size: 11px;
    fill: #888;
}

.bar-text {
  font-size: 11px;
  font-weight: bold;
}
.title-text {
  font-size: 14px;
}
.click-rect {
  pointer-events: all;
  stroke:none;
  fill:#111;
  fill-opacity: 0.0;
  cursor:pointer;
}

figcaption {
  font-size:12px;
  color: #111;
}

.line-path {
  fill:none;
  stroke-width: 2px;
}
.line-marker {
  fill:#ffffff;
  pointer-events: 'none';
  stroke-width: '2px';
}

</style>
{% endblock %}

{% block content %}
        <h1>{{ party.name }}</h1>
        <div class="row">
        <figure>
        <div class="inset">
          <div id="party-history-fig"></div>
        </div>
        </figure>
        </div>
        <div class="row">
          <div class='col-sm-5 col-md-3'>
            <h2>Valresultat</h2>
            <p>Valresultat för {{ party.name.split()[0] }} i Sveriges kommuner i valet 2014.</p>
            <figure>
              <div id='election-map'></div>
              <figcaption style="width:80%">För muspekaren över eller tryck på kartan för att se historiken i en kommun.</figcaption>
            </figure>
          </div>
          <!-- <div id='municipality-timeseries' class='col-md-6 col-xs-12'></div> -->
          <div class='col-sm-7 col-md-9'>
            <h2>Väljarundersökningar</h2>
            <p>
              Figurerna nedan visar hur stor andel tillfrågade i respektive kategori som valt {{ party.name.split()[0] }} som "bästa parti" i Statistiska Centralbyråns undersökningar.
            </p>
            <div class='row'>
              <div class='col-sm-12 col-md-6'>
                <figure>
                  <h3>Indelat efter kön</h3>
                  <div class='inset'>
                    <div id='voter-support-gender'></div>
                  </div>
                  <!-- <figcaption>Könstillhörighet.</figcaption> -->
                </figure>
              </div>
              <div class='col-sm-12 col-md-6'>
                <figure>
                  <h3>Indelat efter utbildning</h3>
                  <div class='inset'>
                    <div id='voter-support-education'></div>
                  </div>
                 <!--  <figcaption>Utbildningsnivå.</figcaption> -->
                </figure>
              </div>
            </div>
          </div>
        </div>
 <!--    <svg id='election-map' class='canvas'></svg> -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
$(function(){
  d3.json("{{ url_for('elections.election', year='2014', abbr=party.abbr|lower) }}",function(error,data) {
    if(error) console.warn(error);
    parties.setup('#election-map',data,"{{ party.abbr|lower }}","2014");
  });


  d3.json("/data/statistics/best_party/latest/gender/{{party.abbr|lower}}.json",function(error,data) {
    if(error) console.warn(error);
    var c = demokratikollen.utils.getPartyColor('{{ party.abbr|lower }}'),
        keyOrder = ["Kvinnor","Män"];
    var chartData = [];

    keyOrder.forEach(function(d) {
      if(isNaN(parseFloat(data[d]))) return;
      chartData.push({
        title: d,
        value: Math.round(parseFloat(data[d])*1000+0.00001)/10,
        color: c
      })
    })

    var parent = d3.select('#voter-support-gender');

    var width = parent[0][0].getBoundingClientRect().width,
        height = 80;

    parties.setupGenderChart(width,height);

    parent.append("svg")
        .attr("height", height)
        .attr("width", width)
        .datum(chartData)
        .call(parties.voterSupportGenderChart);
  });

  d3.json("/data/statistics/best_party/latest/education/{{party.abbr|lower}}.json",function(error,data) {
    if(error) console.warn(error);
    var c = demokratikollen.utils.getPartyColor('{{ party.abbr|lower }}'),
        keyOrder = [
          {orig:"Förgymnasial utbildning",show:"Förgymnasial"},
          {orig:"Gymnasial utbildning",show:"Gymnasial"},
          {orig:"Eftergymnasial utbildning mindre än 3 år",show:"Eftergymnasial < 3 år"},
          {orig:"Eftergymnasial utbildning 3 år eller mer",show:"Eftergymnasial 3+ år"},
          {orig:"Okänd utbildning",show:"Okänd"}
        ];
    var chartData = [];

    keyOrder.forEach(function(d) {
      if(isNaN(parseFloat(data[d.orig]))) return;
      chartData.push({
        title: d.show,
        value: Math.round(parseFloat(data[d.orig])*1000+0.00001)/10,
        color: c
      });
    });

    var parent = d3.select("#voter-support-education");

    var width = parent[0][0].getBoundingClientRect().width,
        height = 150;

    parties.setupEducationChart(width,height);

    var top = parent.append("svg")
      .attr("width", width)
      .attr("height", height)
      .datum(chartData)
      .call(parties.voterSupportEducationChart);
  });
});
</script>
<script type="text/javascript">

  (function () {

    var container = d3.select("#party-history-fig"),
      ar = 5/3,
      partyHistoryChart = demokratikollen.graphics.PartyHistory()
        .baseColor(demokratikollen.utils.getPartyColor('{{ party.abbr|lower }}'));

    function draw () {
      partyHistoryChart.width(demokratikollen.utils.getInnerWidth(container));
      container.html("")
        .call(partyHistoryChart);
    }

    d3.json("/data/party_history/{{party.abbr}}.json", function (data) {
      data.partyLeaders.concat(data.elections).forEach(function (d) { 
        d.start = new Date(d.start);
        d.end = new Date(d.end);
      });

      data.polls.forEach(function (d) {
        d.time = new Date(d.time);
      });
      
      container.datum(data);
      console.log(data)
      draw();
      d3.select(window).on('resize', draw); 
    }) 
  }());


</script>
{% endblock %}